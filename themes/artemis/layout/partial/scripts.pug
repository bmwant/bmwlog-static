//- Theme toggle functionality
script.
    (function() {
        var toggle = document.querySelector('.theme-toggle');
        if (!toggle) return;

        function getTheme() {
            return document.documentElement.getAttribute('data-theme') || 'light';
        }

        function setUtterancesTheme(theme) {
            var utterancesFrame = document.querySelector('.utterances-frame');
            if (utterancesFrame) {
                var utterancesTheme = theme === 'dark' ? 'github-dark' : 'github-light';
                utterancesFrame.contentWindow.postMessage(
                    { type: 'set-theme', theme: utterancesTheme },
                    'https://utteranc.es'
                );
            }
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            setUtterancesTheme(theme);
        }

        toggle.addEventListener('click', function() {
            var currentTheme = getTheme();
            var newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        });

        // Listen for system preference changes
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                // Only auto-switch if user hasn't manually set a preference
                if (!localStorage.getItem('theme')) {
                    var newTheme = e.matches ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', newTheme);
                    setUtterancesTheme(newTheme);
                }
            });
        }
    })();

//- LaTex
if theme.mathjax
    script(async, src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML', integrity='sha384-Ra6zh6uYMmH5ydwCqqMoykyf1T/+ZcnOQfFPhDrp2kI4OIxadnhsvvA2vv9A7xYv', crossorigin='anonymous')
    script(type='text/x-mathjax-config')
        | MathJax.Hub.Config({
        |   tex2jax: {
        |       inlineMath: [['$','$'],['\\(','\\)']],
        |       processClass: "mathjax",
        |       ignoreClass: "no-mathjax"
        |   }
        | });

//- Analytics tracking
if theme.google_analytics
    script(async, src=`https://www.googletagmanager.com/gtag/js?id=${theme.google_analytics}`)
    script.
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', '#{theme.google_analytics}');

//- Firebase Analytics (config loaded from environment variables)
- var fbApiKey = process.env.FIREBASE_API_KEY
- var fbAppId = process.env.FIREBASE_APP_ID
if theme.firebase && theme.firebase.enabled && fbApiKey && fbAppId
    script(type="module").
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAnalytics, logEvent } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';

        const firebaseConfig = {
            apiKey: '#{process.env.FIREBASE_API_KEY}',
            authDomain: '#{process.env.FIREBASE_AUTH_DOMAIN}',
            projectId: '#{process.env.FIREBASE_PROJECT_ID}',
            storageBucket: '#{process.env.FIREBASE_STORAGE_BUCKET}',
            messagingSenderId: '#{process.env.FIREBASE_MESSAGING_SENDER_ID}',
            appId: '#{process.env.FIREBASE_APP_ID}',
            measurementId: '#{process.env.FIREBASE_MEASUREMENT_ID}'
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);

        // Log page view
        logEvent(analytics, 'page_view', {
            page_path: window.location.pathname,
            page_title: document.title
        });

script.
  var fuckrussia = false;  // TODO: this actually should be true everywhere
  if (window.navigator.language !== undefined && window.navigator.language.toLowerCase().includes('ru')) {
    fuckrussia = true;
  }

  if (window.navigator.userLanguage !== undefined && window.navigator.userLanguage.toLowerCase().includes('ru')) {
    fuckrussia = true;
  }

  var hasrulang = window.navigator.languages.map(x => x.toLowerCase()).map(x => x.includes('ru'));
  if (hasrulang.includes(true)) {
    fuckrussia = true;
  }

  if (fuckrussia && window.location.pathname !== '/') {
    window.location.href = '/';
  }
